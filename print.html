<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>re:connect Documentation</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> re:connect</a></li><li class="chapter-item expanded "><a href="app-config/index.html"><strong aria-hidden="true">2.</strong> App configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="app-config/environment.html"><strong aria-hidden="true">2.1.</strong> Environment variables</a></li><li class="chapter-item expanded "><a href="app-config/site-org-name.html"><strong aria-hidden="true">2.2.</strong> Site and organisation names</a></li><li class="chapter-item expanded "><a href="app-config/signups-maintenance.html"><strong aria-hidden="true">2.3.</strong> Signups and maintenance</a></li><li class="chapter-item expanded "><a href="app-config/mail.html"><strong aria-hidden="true">2.4.</strong> Mail preferences</a></li><li class="chapter-item expanded "><a href="app-config/upload.html"><strong aria-hidden="true">2.5.</strong> Upload handling</a></li><li class="chapter-item expanded "><a href="app-config/content-filter.html"><strong aria-hidden="true">2.6.</strong> Content filtering</a></li><li class="chapter-item expanded "><a href="app-config/penpal-status.html"><strong aria-hidden="true">2.7.</strong> Penpal status options</a></li><li class="chapter-item expanded "><a href="app-config/admin-profile.html"><strong aria-hidden="true">2.8.</strong> Administration profile</a></li><li class="chapter-item expanded "><a href="app-config/misc.html"><strong aria-hidden="true">2.9.</strong> Miscellaneous options</a></li></ol></li><li class="chapter-item expanded "><a href="internals/index.html"><strong aria-hidden="true">3.</strong> Internals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="internals/file-uploads.html"><strong aria-hidden="true">3.1.</strong> File uploads</a></li><li class="chapter-item expanded "><a href="internals/email-queue.html"><strong aria-hidden="true">3.2.</strong> Email queueing and templates</a></li></ol></li><li class="chapter-item expanded "><a href="prisoner-search/index.html"><strong aria-hidden="true">4.</strong> Prisoner searching</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">re:connect Documentation</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="reconnect"><a class="header" href="#reconnect">re:connect</a></h1>
<p>re:connect is the user-facing site and automation suite powering the
<a href="https://pcn.nz">Prisoner Correspondence Network</a>. re:connect is developed and
maintained by <a href="https://papa.org.nz">People Against Prisons Aotearoa</a>'s Technology
Working Group.</p>
<p>This documentation acts as both a reference for administrators of a re:connect
installation, as well as a reference for developers contributing to re:connect.</p>
<p>For developers, the <a href="./internals/index.html"><em>Internals</em></a> section contains
information about the internal components of re:connect.</p>
<p>The source code for re:connect, and this documentation, can be found on
GitHub.com at <a href="https://github.com/againstprisons/reconnect">againstprisons/reconnect</a>. The documentation lives in the
<code>docs/</code> subdirectory.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>Both re:connect itself, and this documentation, are released under the MIT
license.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="app-configuration"><a class="header" href="#app-configuration">App configuration</a></h1>
<p>The majority of re:connect's configuration data is stored in the database,
accessible through the <code>/system/configuration</code> endpoint of the application, or
directly through <code>ReConnect::Models::Config</code> objects (when interacting with the
application console).</p>
<p>Some configuration is done through environment variables - these are documented
below in the <a href="app-config/./environment.html">Environment variables</a> section.</p>
<h2 id="note-on-in-database-configuration-value-substitutions"><a class="header" href="#note-on-in-database-configuration-value-substitutions">Note on in-database configuration value substitutions</a></h2>
<p>Configuration values have some substitutions performed when refreshing the
configuration from the database, before being stored in the application
instance.</p>
<p>The available substitutions are:</p>
<ul>
<li><code>@SITEDIR@</code> - replaced with the path to the site directory</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="environment-variables"><a class="header" href="#environment-variables">Environment variables</a></h1>
<h2 id="application-environment"><a class="header" href="#application-environment">Application environment</a></h2>
<p>The value of the <code>RACK_ENV</code> environment variable sets the application
environment. This defaults to <code>production</code> if not set, and should remain set
to <code>production</code> when the application is deployed.</p>
<p>This can be set to <code>development</code>, which is recommended when working on the
codebase.</p>
<h2 id="session-secret"><a class="header" href="#session-secret">Session secret</a></h2>
<p>The value of the <code>SESSION_SECRET</code> environment variable sets the secret used for
signing of user sessions. This should be set to a sufficiently random string.</p>
<p>Changing this value will invalidate all existing sessions.</p>
<h2 id="database"><a class="header" href="#database">Database</a></h2>
<p>The <code>DATABASE_URL</code> environment variable should be set to a connection string
for your database. For SQlite, this would be something along the lines of
<code>sqlite:///home/user/reconnect.sqlite3</code>.</p>
<h2 id="site-directory"><a class="header" href="#site-directory">Site directory</a></h2>
<p>The <code>SITE_DIR</code> environment variable sets the directory used for per-site
configuration and data storage.</p>
<p>If a file named <code>config.rb</code> exists in this directory, it is loaded at
application initialization time.</p>
<p>The default location for uploaded files is the <code>files</code> subdirectory of this
directory.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="site-and-organisation-names"><a class="header" href="#site-and-organisation-names">Site and organisation names</a></h1>
<p>The displayed site name and organisation name are stored in the database as the
<code>site-name</code> and <code>org-name</code> configuration keys, respectively.</p>
<p>These can be changed through the web interface at
<code>/system/configuration/site-org-name</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="signups-and-maintenance"><a class="header" href="#signups-and-maintenance">Signups and maintenance</a></h1>
<p>Both of these options have quick toggle buttons in the web interface at
<code>/system/configuration</code>.</p>
<h2 id="maintenance-mode"><a class="header" href="#maintenance-mode">Maintenance mode</a></h2>
<p>Maintenance mode is toggled by the <code>maintenance</code> boolean config entry. When
maintenance mode is enabled, only users who have the
<code>site:use_during_maintenance</code> permission can use the site.</p>
<h2 id="signups"><a class="header" href="#signups">Signups</a></h2>
<p>Whether signups are enabled is toggled by the <code>signups</code> boolean config entry.
When signups are disabled, navigating to the signup page will present a message
saying signups are disabled. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mail-preferences"><a class="header" href="#mail-preferences">Mail preferences</a></h1>
<p>Mail preferences can be changed through the web interface at
<code>/system/configuration/mail</code>.</p>
<h2 id="email-from-address"><a class="header" href="#email-from-address">Email from address</a></h2>
<p>The email address used in the &quot;From&quot; field of outgoing emails is stored in the
database as the <code>email-from</code> configuration key. </p>
<h2 id="subject-line-prefix"><a class="header" href="#subject-line-prefix">Subject line prefix</a></h2>
<p>The prefix used for email subject lines is stored in the database as the
<code>email-subject-prefix</code> key. The available options are:</p>
<ul>
<li><code>none</code>: No prefix (<code>Subject</code>)</li>
<li><code>org-name</code>: Organisation name, followed by a colon (<code>Organisation Name: Subject</code>)</li>
<li><code>org-name-brackets</code>: Organisation name, in brackets (<code>[Organisation Name] Subject</code>)</li>
<li><code>site-name</code>: Organisation name, followed by a colon (<code>Site Name: Subject</code>)</li>
<li><code>site-name-brackets</code>: Organisation name, in brackets (<code>[Site Name] Subject</code>)</li>
</ul>
<h2 id="smtp-login-details"><a class="header" href="#smtp-login-details">SMTP login details</a></h2>
<p>The SMTP login details, as a URL, are stored in the database as the
<code>email-smtp-host</code> key.</p>
<p>The URL scheme is ignored, and when the web interface changes the URL, it does
not add a scheme.</p>
<p>The username, password, host, and port are specified in the standard URL format.
However, the username and password fields are both URL escaped. As an example,
to connect to the SMTP server at <code>localhost:1234</code> with a username of
<code>test@example.com</code> and a password of <code>P@55word</code>, the URL would look like the
following: <code>//test%40example.com:P%4055word@localhost:1234</code>.</p>
<p>Other options are controlled by query parameters on the URL. The available
options are:</p>
<ul>
<li><code>starttls</code> - whether to enable StartTLS (<code>yes</code> to enable, any other value to
disable; default: not set)</li>
<li><code>tls</code> - whether to enable TLS (<code>yes</code> to enable, any other value to disable;
default: not set)</li>
<li><code>verify_mode</code> - OpenSSL verification mode (options: <code>NONE</code> for no
verification, <code>PEER</code> for full peer verification; default: <code>PEER</code>)</li>
<li><code>authentication</code> - SMTP authentication mode (default: <code>plain</code>)</li>
</ul>
<p><strong>NOTE:</strong> As a special case, for development usage, if the <code>email-smtp-host</code>
key is set to <code>logger</code>, SMTP is disabled and outgoing emails are printed to the
console logger.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="upload-handling"><a class="header" href="#upload-handling">Upload handling</a></h1>
<h2 id="upload-directory"><a class="header" href="#upload-directory">Upload directory</a></h2>
<p>The <code>file-storage-dir</code> config entry determines the path for uploaded files. By
default, this is set to <code>@SITEDIR@/files</code> - meaning the <code>files</code> subdirectory of
the site directory (see <a href="app-config/./index.html#note-on-in-database-configuration-value-substitutions">the note on substitutions</a>).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="content-filtering"><a class="header" href="#content-filtering">Content filtering</a></h1>
<p>re:connect has a content filter used for outside-to-inside correspondence.
Specifically, it is applied to the supplied text when a normal user submits new
correspondence via <code>/penpal/:id/correspondence/create</code>.</p>
<p>This filter can be configured in the web UI, at <code>/system/configuration/filter</code>.
It is configured by the configuration database entries prefixed with <code>filter</code>.
The format of these is documented below.</p>
<h2 id="filter-enabled"><a class="header" href="#filter-enabled">filter-enabled</a></h2>
<p>The <code>filter-enabled</code> boolean option toggles whether to use the content filter.
By default this is set to <code>yes</code>.</p>
<h2 id="filter-words"><a class="header" href="#filter-words">filter-words</a></h2>
<p>The <code>filter-words</code> configuration option is a JSON array of words that will
trigger the filter. By default, this is set to <code>[]</code> (an empty array).</p>
<p>Note that if the value of the <code>filter-words</code> configuration entry is malformed
JSON, and can't be parsed, it will be set to an empty array, effectively
disabling the content filter. If this is the case, a warning will be printed to
stdout when the config is refreshed, and the configuration UI will also show a
warning.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="penpal-status-options"><a class="header" href="#penpal-status-options">Penpal status options</a></h1>
<p>The available options for the status of incarcerated penpals, viewable on
individual penpal pages as well as in the address book, are configurable with
the below configuration entries.</p>
<h2 id="status-options"><a class="header" href="#status-options">Status options</a></h2>
<p>The <code>penpal-statuses</code> configuration entry is a JSON array of valid statuses
for incarcerated penpals.</p>
<h2 id="default-status"><a class="header" href="#default-status">Default status</a></h2>
<p>The content of the <code>penpal-status-default</code> configuration entry is taken as the
default status to assign to new penpals, as well as penpals who have not had
a status set for some reason.</p>
<p>This must be set to a value that is also included in the <code>penpal-statuses</code>
array, setting it to a value that is not in that array is undefined behaviour
and could cause issues.</p>
<h2 id="status-transitions"><a class="header" href="#status-transitions">Status transitions</a></h2>
<p>The content of the <code>penpal-status-transitions</code> configuration entry is used to
perform automatic transitions between different penpal statuses.</p>
<p>The available triggers are:</p>
<ul>
<li><code>last_correspondence</code> - transition when the penpal's last correspondence was
before the time period specified in the <code>last_correspondence</code> key.</li>
<li><code>penpal_count</code> - transition when the penpal has more penpal relationships
(excluding the relationship with the admin profile, if that exists) than is
specified in the <code>penpal_count</code> key.</li>
</ul>
<p>The <code>mode</code> key can be either a string, in which case the transition is applied
if the conditions for that trigger are met, or an array of strings, in which
case the transition is applied only if the conditions for all of the specified
triggers are met.</p>
<p>For example, to change a penpal's status from <code>Active</code> to <code>Inactive</code> after
6 months without any new correspondence, the field could be set like this:</p>
<pre><code class="language-json">[
  {
    &quot;from&quot;: &quot;Active&quot;,
    &quot;to&quot;: &quot;Inactive&quot;,
    &quot;when&quot;: {
      &quot;mode&quot;: &quot;last_correspondence&quot;,
      &quot;last_correspondence&quot;: &quot;6 months ago&quot;,
    }
  }
]
</code></pre>
<p>Note that the <code>from</code> and <code>to</code> values must be valid entries in the
<code>penpal-statuses</code> array.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="administration-profile"><a class="header" href="#administration-profile">Administration profile</a></h1>
<p>re:connect has an &quot;administration profile&quot; feature, which allows for
centralising communications between the administration team of the penpal
network and incarcerated penpals.</p>
<p>This administration profile is a standard penpal profile, that has no
associated user, and does not have the &quot;is incarcerated&quot; flag set.</p>
<p>For more information, see <a href="https://github.com/againstprisons/reconnect/commit/4df2f28f">the commit that introduced this feature</a>.</p>
<h2 id="admin-profile-id"><a class="header" href="#admin-profile-id">admin-profile-id</a></h2>
<p>The <code>admin-profile-id</code> configuration option is the numerical ID of the penpal
profile that should be used as the administration profile.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="miscellaneous-options"><a class="header" href="#miscellaneous-options">Miscellaneous options</a></h1>
<h2 id="version-display"><a class="header" href="#version-display">Version display</a></h2>
<p>The <code>display-version</code> boolean option toggles the display of detailed version
information in both the page footer and the <code>&lt;meta name=&quot;generator&quot;&gt;</code> tag in
the rendered page.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="internals"><a class="header" href="#internals">Internals</a></h1>
<p>This section of the documentation is for developers contributing to re:connect.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="file-uploads"><a class="header" href="#file-uploads">File uploads</a></h1>
<h2 id="uploading"><a class="header" href="#uploading">Uploading</a></h2>
<p>File uploads are handled by the <code>ReConnect::Models::File#upload</code> method, which
takes the uploaded file data as a string, and an (optional) options hash.</p>
<p>The available keys for the options hash are:</p>
<ul>
<li><code>:filename</code> - The original filename of the uploaded file</li>
</ul>
<p>The <code>File#upload</code> function generates a unique file ID. This ID is used for file
lookups, and is used for key derivation for encrypting the uploaded file.</p>
<p>All uploaded files are encrypted on disk using the standard <code>ReConnect::Crypto</code>
functions. The key derivation parameters are as follows:</p>
<ul>
<li>Table: <code>&quot;file&quot;</code></li>
<li>Column: the file ID (as a hexadecimal string)</li>
<li>Row: <code>&quot;&quot;</code> (empty string)</li>
</ul>
<h2 id="storage"><a class="header" href="#storage">Storage</a></h2>
<p>The <code>files</code> database table stores information about uploaded files. This table
stores the following:</p>
<ul>
<li><code>file_id</code>: The generated file ID</li>
<li><code>file_hash</code>: The SHA256 digest of the encrypted file</li>
<li><code>creation</code>: The time this file was uploaded</li>
<li><code>mime_type</code>: The detected MIME type</li>
<li><code>original_fn</code>: The original filename of this file, as passed to <code>File#upload</code></li>
</ul>
<p>Uploaded files are stored in a directory configured by the <code>file-storage-dir</code>
configuration setting. Within the configured directory, files are stored in
subfolders, the names of which are the hexadecimal representation of the first
byte of the SHA256 hash of the file. As an example, for a hash of <code>a0b1c2...</code>,
the file path would be <code>#{upload_dir}/a0/a0b1c2...</code>.</p>
<h2 id="downloading"><a class="header" href="#downloading">Downloading</a></h2>
<p>Files are downloaded through the <code>/filedl/:fileid/:token</code> endpoint, where
<code>:fileid</code> is the file's ID, and <code>:token</code> is a download token.</p>
<p>A download token is a standard token with the <code>use</code> field set to
<code>file_download</code>, and the <code>extra_data</code> field set to the file's ID. Download
tokens are generated by the <code>generate_download_token(user)</code> method on a File
object (passing in the <code>User</code> object to create the token for), which returns a
<code>ReConnect::Models::Token</code> object. Download tokens expire 1 hour after their
creation.</p>
<p>When a client requests to download a file, the endpoint checks that the provided
token is valid and has not expired, that the token's user matches the logged in
user, and that the <code>extra_data</code> field on the token matches the requested file.</p>
<p>If all of these checks are successful, the endpoint decrypts the file and
serves it to the client.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="email-queueing-and-templates"><a class="header" href="#email-queueing-and-templates">Email queueing and templates</a></h1>
<p>Emails are sent by a scheduled Sidekiq job, pulling the email data from the
database. Emails are handled by the <code>ReConnect::Models::EmailQueue</code> model.</p>
<p>Emails can be sent with both text and HTML parts, and can have arbitrary
attachments.</p>
<h2 id="queueing-a-new-email"><a class="header" href="#queueing-a-new-email">Queueing a new email</a></h2>
<p>To queue a new email with custom content, first create an <code>EmailQueue</code> instance,
save it using <code>instance.save()</code> (to generate an ID), and then add the data
by encrypting it on the model using the <code>instance.encrypt(field, data)</code> method.</p>
<p>The <code>content_text</code> and <code>content_html</code> encrypted fields store the contents of
the text and HTML parts, respectively.</p>
<p>The <code>subject</code> encrypted field stores the email subject line.</p>
<p>The email queue sender only sends emails that have their <code>queue_status</code> set to
<code>&quot;queued&quot;</code>. The <code>queue_status</code> field is <strong>not</strong> encrypted.</p>
<h3 id="recipients-list"><a class="header" href="#recipients-list">Recipients list</a></h3>
<p>The recipients list can be either a list of email addresses to send to, or a
list of roles (to send the email to everyone who has those roles). The
recipients list is stored as JSON in the <code>recipients</code> encrypted field of the
model.</p>
<p>To send to a list of email addresses, the following JSON would be used:</p>
<pre><code class="language-json">{
  &quot;mode&quot;: &quot;list&quot;,
  &quot;list&quot;: [
    &quot;user_one@example.com&quot;,
    &quot;user_two@example.com&quot;
  ]
}
</code></pre>
<p>To send to all users with the given roles, the following JSON would be used:</p>
<pre><code class="language-json">{
  &quot;mode&quot;: &quot;roles&quot;,
  &quot;roles&quot;: [
    &quot;system:alert_emails&quot;
  ]
}
</code></pre>
<h3 id="attachments"><a class="header" href="#attachments">Attachments</a></h3>
<p>The attachments to the email are stored an JSON in the <code>attachments</code> encrypted
field of the model. The JSON is in the format of an array of hashes, with
<code>&quot;filename&quot;</code> and <code>&quot;content&quot;</code> keys. Multiple attachments are allowed.</p>
<p>An example:</p>
<pre><code class="language-json">[
  {
    &quot;filename&quot;: &quot;test.txt&quot;,
    &quot;content&quot;: &quot;This is a test text file!&quot;
  }
]
</code></pre>
<h2 id="email-templates"><a class="header" href="#email-templates">Email templates</a></h2>
<p>To send an email using a template, you can call the <code>new_from_template</code> method
on the <code>EmailQueue</code> class, passing in the name of the template to use, and
a hash of data to pass to the template.</p>
<p>After doing this, you must manually set the queue status, set a subject line, 
and add a list of recipients.</p>
<p>An example:</p>
<pre><code class="language-ruby">email = ReConnect::Models::EmailQueue.new_from_template(&quot;password_reset&quot;, data)
email.queue_status = &quot;queued&quot;
email.encrypt(:subject, &quot;Password reset&quot;)
email.encrypt(:recipients, recipients_list)
email.save
</code></pre>
<h3 id="previewing-an-email-template"><a class="header" href="#previewing-an-email-template">Previewing an email template</a></h3>
<p>You can preview any email template by visiting the
<code>/system/debugging/emailpreview/:lang/:template.:type</code> page, where <code>:lang</code> is
the template language, <code>:template</code> is the template name, and <code>:type</code> is the
template type (either <code>html</code> or <code>txt</code>).</p>
<p>You can pass in a <code>data</code> query parameter, containing JSON data, which is passed
to the template.</p>
<p>For example, for the HTML version of the password reset template, you could
visit <code>/system/debugging/emailpreview/en/password_reset.html</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prisoner-searching"><a class="header" href="#prisoner-searching">Prisoner searching</a></h1>
<p>Some search fields in re:connect, including the search field within the
address sticker generation section, let you combine a variety of search
terms.</p>
<p>When searching using one of these fields, there are a few search operators
that you can use, which are generally in the format <code>&lt;type&gt;:&lt;parameter&gt;</code>.
These operators include:</p>
<ul>
<li><code>prison:&lt;id&gt;</code> - All prisoners in the given prison</li>
<li><code>status:&quot;&lt;status&gt;&quot;</code> - All prisoners with the given status</li>
</ul>
<h2 id="search-inclusivity"><a class="header" href="#search-inclusivity">Search inclusivity</a></h2>
<p>By default, all prisoners who match <strong>any</strong> of the search terms will be
returned in the search results. To only return prisoners who match <strong>all</strong>
of the search terms, you can add the <code>all</code> option.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>To return all prisoners in the prison with ID <code>1</code>: </p>
<pre><code>prison:1
</code></pre>
<p>To return the list of prisoners who are marked as &quot;Active&quot; who are in the
prison with ID <code>1</code>:</p>
<pre><code>all prison:1 status:&quot;Active&quot;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
